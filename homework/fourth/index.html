<!DOCTYPE html>
<html>
   <head>
      <meta charset=utf-8>
      <title>Tree.js scene</title>
      <style>
         body { margin: 0; }
         canvas { position: fixed; }
      </style>
   </head>
   <body>
      <script src="js/tree.min.js"></script>
      <script src="js/controls/TrackballControls.js"></script>
      <script src="js/particleSystem.js"></script>
      <script>
        var camera, tick = 0,
        scene, renderer, clock = new THREE.Clock(true),
        controls, container,
        options, spawnerOptions, particleSystem;

        init();
        drawCube();
        lightsOn();
        render();

        function init() {
          camera = new THREE.PerspectiveCamera(28, window.innerWidth / window.innerHeight, 1, 10000);
          camera.position.z = 100;
          scene = new THREE.Scene();
          particleSystem = new THREE.GPUParticleSystem({
            maxParticles: 250000
          });
          scene.add(particleSystem);

          options = {
            position: new THREE.Vector3(),
            positionRandomness: .3,
            velocity: new THREE.Vector3(),
            velocityRandomness: .5,
            color: 0xaa88ff,
            colorRandomness: .2,
            turbulence: .5,
            lifetime: 2,
            size: 1,
            sizeRandomness: 1
          };

          spawnerOptions = {
            spawnRate: 15000,
            horizontalSpeed: .75,
            verticalSpeed: .75,
            timeScale: 1
          };

          renderer = new THREE.WebGLRenderer();
          renderer.setPixelRatio(window.devicePixelRatio);
          renderer.setSize(window.innerWidth, window.innerHeight);
          document.body.appendChild(renderer.domElement);

          controls = new THREE.TrackballControls(camera, renderer.domElement);
          controls.rotateSpeed = 5.0;
          controls.zoomSpeed = 2.2;
          controls.panSpeed = 1;
          controls.dynamicDampingFactor = 0.3;

          window.addEventListener('resize', onWindowResize, false);
        };

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      };

      function drawCube() {
        var geometry = new THREE.BoxGeometry(1, 1, 1);
        var material = new THREE.MeshLambertMaterial({color: 0x00ff00});
        cube = new THREE.Mesh(geometry, material);
        scene.add(cube);
      };

      function lightsOn() {
        var light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(100, 100, 50);
        scene.add(light);
      };

      function render() {
        requestAnimationFrame(render);
        controls.update();

        var delta = clock.getDelta() * spawnerOptions.timeScale;
        tick += delta;

        if (tick < 0) tick = 0;

        if (delta > 0) {
          options.position.x = Math.sin(tick * spawnerOptions.horizontalSpeed) * 2;
          options.position.y = Math.sin(tick * spawnerOptions.verticalSpeed) * 1.2;
          options.position.z = Math.sin(tick * spawnerOptions.horizontalSpeed + spawnerOptions.verticalSpeed) * .5;

          for (var x = 0; x < spawnerOptions.spawnRate * delta; x++) {
            particleSystem.spawnParticle(options);
          }
        }

        particleSystem.update(tick);
        renderer.render(scene, camera);
      };
      </script>
   </body>
</html>
